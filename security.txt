# Aero Safety Security Best Practices Reference

## 1. Row Level Security (RLS)
- **RLS is enabled on all sensitive tables** (e.g., users, user_organizations, bookings, invoices, lessons, etc.).
- **Policies strictly scope data access** to the authenticated user and their organization.
- **No data is accessible to unauthorized users, even if they know a record UUID.**

## 2. Organization Scoping & Multi-Tenancy
- **All queries are filtered by `organization_id`** (from a secure, httpOnly cookie: `current_org_id`).
- **No cross-organization access is possible**â€”all endpoints and queries require both the record ID and the current organization ID to match.
- **Defense in depth:** Even if RLS is misconfigured, API routes and queries always check `organization_id`.

## 3. User Membership Enforcement
- **All user lookups and member lists are joined through `user_organizations`** to ensure the user is a member of the current organization.
- **Endpoints like `/api/users` and `/api/invoices` only return users who are members of the current org.**
- **No user/member can be referenced on a record unless they belong to the org.**

## 4. Authentication & Authorization
- **All API routes require authentication** (Supabase Auth JWT in cookie).
- **No sensitive data is returned if the user is not authenticated.**
- **All mutations (PATCH/DELETE) require both authentication and org scoping.**

## 5. Client/Server Data Separation
- **Sensitive data is never exposed client-side unless required.**
- **All org/user checks are performed server-side (API routes, server components).**
- **Client components only receive data they are authorized to see.**

## 6. Secure Cookies
- **`current_org_id` is stored as a secure, httpOnly cookie.**
- **Supabase session tokens are httpOnly and never exposed to JS.**

## 7. API Endpoint Patterns
- **All GET, PATCH, DELETE, and POST endpoints check both authentication and organization.**
- **All user/member lookups are joined through `user_organizations` for extra safety.**
- **No endpoint ever returns data for another org, even if a valid UUID is provided.**

## 8. General Principles
- **Never trust client input for authorization.**
- **Always validate and scope on the server.**
- **Keep a single source of truth for org/user context (cookie + RLS + join).**
- **Review and test RLS policies regularly.**

---

_Reference this document for all future development to ensure robust, multi-tenant, aviation-grade security._
