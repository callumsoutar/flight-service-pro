# Maintenance Extensions & Aircraft Component Service Workflow

## 1. User Flow: Logging a Maintenance Visit
- **User navigates** to the Aircraft Servicing tab or component view in the dashboard.
- **User clicks** the "Log Maintenance" button for a specific component/service (e.g., 100 Hour Inspection).
- A **modal appears** prompting for:
  - Date of service
  - Hours at visit (tach/time)
  - Any notes, costs, or additional details
- **User submits** the form to log the visit.

## 2. API & Backend Logic
- The frontend sends a POST request to `/api/maintenance_visits` with the visit details and the `component_id`.
- **API logic:**
  1. **Insert** the new maintenance visit into the `maintenance_visits` table.
  2. **If the visit is for a component:**
     - Fetch the current component record from `aircraft_components`.
     - Calculate the new due values:
       - `last_completed_hours` = hours at which maintenance was performed
       - `scheduled_due_hours` = last_completed_hours + interval_hours
       - `current_due_hours` = scheduled_due_hours
       - `current_due_date` = calculated if interval is calendar-based
     - **Clear any extension:**
       - `extension_limit_hours` is set to `null` (removes any previous extension)
     - **Update** the component record with these new values.
  3. **If costs are included:**
     - Insert a record into `maintenance_costs` linked to the visit and/or component.
  4. **All updates are performed in a transaction** for auditability and atomicity.

## 3. Database Schema & Fields
- **maintenance_visits**
  - id, aircraft_id, component_id, visit_date, hours_at_visit, notes, status, etc.
- **aircraft_components**
  - id, aircraft_id, name, interval_type, interval_hours, interval_days, last_completed_hours, scheduled_due_hours, current_due_hours, extension_limit_hours, current_due_date, etc.
- **maintenance_costs**
  - id, maintenance_visit_id, aircraft_component_id, amount, description, created_at, etc.

## 4. Extension Logic (Aviation Compliance)
- Extensions (e.g., 10% of interval) can be granted for a component, setting `extension_limit_hours`.
- When a maintenance visit is logged (status 'Completed'):
  - The extension is **cleared** (`extension_limit_hours = null`).
  - The next due is calculated from the performed hours, **not** from the extension.
  - This prevents cumulative extensions and ensures compliance.
- If a component is within extension (current hours > scheduled_due_hours but <= extension_limit_hours), the UI and status reflect "Within Extension".
- If current hours > extension_limit_hours, the component is "Overdue (after extension)".

## 5. Costs & Auditability
- Maintenance costs can be logged with each visit.
- All changes to components and visits are auditable via the database (and optionally, audit logs).
- The system supports full traceability of who performed/approved extensions and maintenance.

## 6. UI/UX Summary
- The Servicing tab and component views show:
  - Service Name, Due At (hrs/date), Extension Limit, Days Until Service, Due In, Status, Actions
  - "Within Extension" badge appears under the service name if applicable
  - Status column shows: Due Soon, Overdue, Overdue (after extension), or Extension
- Logging a visit resets the extension and starts a new cycle.
- Users cannot grant a new extension until the next cycle.

## 7. Edge Cases & Best Practices
- If a visit is logged with hours below the scheduled due, the system still resets the cycle (for early maintenance).
- If a visit is edited to "Completed", the same logic applies.
- All calculations are rounded and validated for accuracy.
- The system is designed for aviation regulatory compliance and auditability.

---

**This document serves as the definitive reference for how maintenance extensions, service logging, costs, and aircraft component scheduling work in the Aero Safety system.**
